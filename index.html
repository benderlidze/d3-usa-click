<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>D3</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
    <script type="text/javascript" src="https://d3js.org/topojson.v3.min.js"></script>

    <style>
        .background {
            fill: none;
            pointer-events: all;
        }

        #states {
            fill: #3689ff;
        }

        #states .active {
            fill: #0057ce;
            /* display: none; */
        }

        #state-borders {
            fill: none;
            stroke: #fff;
            stroke-width: 1.5px;
            stroke-linejoin: round;
            stroke-linecap: round;
            pointer-events: none;
        }

        .county-boundary {
            fill: #aaa;
            stroke: #fff;
            stroke-width: .5px;
        }

        .county-boundary:hover,
        .state:hover {
            fill: #0057ce;
        }
    </style>
</head>

<body>
    <div class="viz"></div>
    <script type="text/javascript">

        const markers = []
        var margin = {
            top: 10,
            bottom: 10,
            left: 10,
            right: 10
        }, width = parseInt(d3.select('.viz').style('width'))
            , width = width - margin.left - margin.right
            , mapRatio = 0.5
            , height = width * mapRatio
            , active = d3.select(null);

        var svg = d3.select('.viz').append('svg')
            .attr('class', 'center-container')
            .attr('height', height + margin.top + margin.bottom)
            .attr('width', width + margin.left + margin.right);

        svg.append('rect')
            .attr('class', 'background center-container')
            .attr('height', height + margin.top + margin.bottom)
            .attr('width', width + margin.left + margin.right)
            .on('click', clicked);

        fetch('usa.topojson')
            .then(data => d3.json('usa.topojson'))
            .then(ready)

        d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vQEMTmLV4k9lCD2y896NLuItwwGO36wUBoMppWebFxNKjlRXOsPE2cLgtLUc5qsiZC1MQvESvYa-1TL/pub?output=csv")
            .then(json => {
                console.log('json', json);
                markers.push(...json)
            })

        var projection = d3.geoAlbersUsa()
            .translate([width / 2, height / 2])
            .scale(width);

        var path = d3.geoPath()
            .projection(projection);

        var g = svg.append("g")
            .attr('class', 'center-container center-items us-state')
            .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)

        function ready(us) {

            // g.append("g")
            //     .attr("id", "counties")
            //     .selectAll("path")
            //     .data(topojson.feature(us, us.objects.counties).features)
            //     .enter().append("path")
            //     .attr("d", path)
            //     .attr("class", "county-boundary")
            //     .on("click", reset);

            g.append("g")
                .attr("id", "states")
                .selectAll("path")
                .data(topojson.feature(us, us.objects.states).features)
                .enter().append("path")
                .attr("d", path)
                .attr("class", "state")
                .on("click", clicked);


            g.append("path")
                .datum(topojson.mesh(us, us.objects.states, function (a, b) { return a !== b; }))
                .attr("id", "state-borders")
                .attr("d", path);

        }

        function clicked(d) {
            if (d3.select('.background').node() === this) return reset();

            if (active.node() === this) return reset();

            active.classed("active", false);
            active = d3.select(this).classed("active", true);

            var bounds = path.bounds(d),
                dx = bounds[1][0] - bounds[0][0],
                dy = bounds[1][1] - bounds[0][1],
                x = (bounds[0][0] + bounds[1][0]) / 2,
                y = (bounds[0][1] + bounds[1][1]) / 2,
                scale = .9 / Math.max(dx / width, dy / height),
                translate = [width / 2 - scale * x, height / 2 - scale * y];

            svg.selectAll('circle').remove()

            g.transition()
                .duration(750)
                .style("stroke-width", 1.5 / scale + "px")
                .attr("transform", "translate(" + translate + ")scale(" + scale + ")")
                .on("end", () => {

                    g.selectAll(".mark")
                        .data(markers)
                        .enter()
                        .append("image")
                        .attr('class', 'mark')
                        .attr('width', 40)
                        .attr('height', 40)
                        .attr("xlink:href", 'icon.png')
                        .attr("transform", function (d) {
                            console.log(`translate(" + ${projection([d.lng, d.lat])} + ")scale(" + 1 / ${scale} + ")`);
                            console.log('scale', scale);

                            if (scale > 3) scale = 1;

                            return "translate(" + projection([d.lng, d.lat]) + ")scale(" + 1 / scale + ")";
                        })
                        .on("mouseover", function (b) {
                            d3.select(this).style("fill", "red").append('text')
                                .text("hi");
                        })
                        .on("mouseout", function () {
                            d3.select(this).style("fill", "blue");
                        })
                        .on("click", function () {
                            console.log('click',);
                        });

                });



        }


        function reset() {
            active.classed("active", false);
            active = d3.select(null);

            g.transition()
                .delay(100)
                .duration(750)
                .style("stroke-width", "1.5px")
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

            svg.selectAll('circle').remove()
        }
    </script>
</body>

</html>